#!/bin/bash
#set -x

TOTAL_SAVED=0
print_summary () {
  if [[ $TOTAL_SAVED -gt 0 ]]; then
      echo "Total space saved: $(numfmt --to=iec-i --suffix=B --padding=7 --from-unit=512 $TOTAL_SAVED)"
  fi
}
clean_folder () {
  if [ -d "$1" -a ! -h "$1" ]; then
    if [ -z "$2" ]
      then
        local SIZE=$(du -s $1|cut -f1)
      else
        local SIZE=$2
    fi

    if [[ $SIZE -gt 0 ]]; then
        read -e -p "Delete directory \"$1\" with size $(numfmt --to=iec-i --suffix=B --padding=7 --from-unit=512 $SIZE) (Y/n/s)" CONFIRMATION
        local CONFIRMATION=${CONFIRMATION:-Y}
        if [[ $CONFIRMATION =~ ^[Yy]$ ]]
          then
            trash -r $1
#            rm -r $1
            TOTAL_SAVED=$((TOTAL_SAVED+SIZE ))
#            echo "Deleted"
          else
            if [[ $CONFIRMATION =~ ^[Ss]$ ]]
            then
              echo "Stopped"
              print_summary
              exit
            fi
        fi
    fi
  fi
}
#

clean_folder "$HOME/.npm"
clean_folder "$HOME/.node-gyp"
clean_folder "$HOME/.yarn-cache"
clean_folder "$(yarn cache dir)"
clean_folder "$TMPDIR/metro-cache"

#You can add any other cache folders here
#clean_folder "$HOME/.vagrant.d/boxes"
#clean_folder "$HOME/.gradle/caches"
#clean_folder "$HOME/.gradle/wrapper"
#clean_folder "$HOME/.gem"
#clean_folder "$HOME/.m2/repository"

echo "Search all node_modules in current folder"
IFS=$'\n'
for i in $(find . -name node_modules -type d -exec du -s {} \; | sort -nr); do
  DIR=$(echo $i|cut -f2)
  DIR_SIZE=$(echo $i|cut -f1)
  #skip inner node_nodules
  if [[ ! $DIR =~ ^.*node_modules.*node_modules.*$ ]];
  then
      clean_folder "$DIR" "$DIR_SIZE"
  fi
done

print_summary
